name: Build, Push to GHCR, and Deploy to EC2

on:
  push:
    branches: ["main"]

env:
  IMAGE_NAME: nextjsapp
  IMAGE_REGISTRY: ghcr.io/checho0001  # lowercase username

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.IMAGE_REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and Push Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: |
            ${{ env.IMAGE_REGISTRY }}/${{ env.IMAGE_NAME }}:latest
            ${{ env.IMAGE_REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - name: SSH to EC2 and deploy container
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_KEY }}
          script: |
            # Ensure Docker is installed
            if ! command -v docker &> /dev/null; then
              sudo apt update -y
              sudo DEBIAN_FRONTEND=noninteractive apt install -y docker.io
            fi

            # Non-interactive login to GHCR
            echo "${{ secrets.GHCR_TOKEN }}" | sudo docker login ghcr.io -u ${{ secrets.GHCR_USERNAME }} --password-stdin

            # Use SHA-tagged image
            IMAGE="${{ env.IMAGE_REGISTRY }}/${{ env.IMAGE_NAME }}:${GITHUB_SHA}"

            # Stop and remove old container if exists
            sudo docker stop nextjs-app || true
            sudo docker rm nextjs-app || true

            # Pull and run new container
            sudo docker pull $IMAGE
            sudo docker run -d --name nextjs-app -p 80:3000 $IMAGE

            # Optional: cleanup dangling images
            sudo docker image prune -f
      - name: Notify Lambda After Deployment
        if: always()
        env:
          LAMBDA_URL: ${{ secrets.LAMBDA_URL }}
          JOB_STATUS: ${{ job.status }}
        run: |
          cat << 'EOF' > send_status.mjs
          import process from "node:process";

          const LAMBDA_URL = process.env.LAMBDA_URL;
          if (!LAMBDA_URL) {
            console.error("‚ùå Missing LAMBDA_URL environment variable.");
            process.exit(1);
          }

          const repo = process.env.GITHUB_REPOSITORY || "unknown-repo";
          const branch = process.env.GITHUB_REF_NAME || "unknown-branch";
          const commit = process.env.GITHUB_SHA || "unknown-sha";
          const actor = process.env.GITHUB_ACTOR || "unknown-actor";
          const jobStatus = process.env.JOB_STATUS || "unknown";

          const payload = {
            repository: repo,
            branch: branch,
            status: jobStatus,
            timestamp: new Date().toISOString(),
            details: {
              commit: commit,
              triggered_by: actor
            }
          };

          console.log("üì¶ Payload to send:");
          console.log(JSON.stringify(payload, null, 2));

          console.log(`üöÄ Sending to Lambda URL: ${LAMBDA_URL}`);

          try {
            const response = await fetch(LAMBDA_URL, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload)
            });

            const text = await response.text();

            console.log("üåê Lambda response code:", response.status);
            console.log("üì® Lambda response body:", text);

            if (!response.ok) {
              console.error("‚ùå Lambda returned an error.");
              process.exit(1);
            }

            console.log("‚úÖ Successfully sent status to Lambda/S3");
          } catch (err) {
            console.error("‚ùå Error sending request to Lambda:");
            console.error(err);
            process.exit(1);
          }
          EOF

          node send_status.mjs
